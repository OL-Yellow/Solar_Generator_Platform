{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <!-- Progress Bar -->
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <!-- Calculator Form -->
    <form id="calculator-form" class="needs-validation" novalidate>
        <!-- Step 1: User Type and Location -->
        <div id="step1" class="step-container">
            <h3 class="mb-4">Basic Information</h3>
            <div class="mb-3">
                <label for="user-type" class="form-label">User Type</label>
                <select class="form-select" id="user-type" required>
                    <option value="household" selected>Household</option>
                    <option value="business">Business</option>
                </select>
                <div class="invalid-feedback">Please select a user type.</div>
            </div>
            <div class="mb-3">
                <label for="location" class="form-label">Location</label>
                <select class="form-select" id="location" required>
                    {% for location, hours in locations.items() %}
                    <option value="{{ hours }}" {% if location == "Lagos" %}selected{% endif %}>{{ location }}</option>
                    {% endfor %}
                </select>
                <div class="invalid-feedback">Please select your location.</div>
            </div>
            <input type="hidden" id="sun-hours" value="">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-solar btn-next">Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Step 2: Generator Usage -->
        <div id="step2" class="step-container d-none">
            <h3 class="mb-4">Current Generator Usage</h3>
            <div class="mb-3">
                <label for="generator-size" class="form-label">Generator Size (kW)</label>
                <select class="form-select" id="generator-size" required>
                    <option value="2.5" selected>2.5 kW (Small Home)</option>
                    <option value="4">4.0 kW (Medium Home)</option>
                    <option value="6.5">6.5 kW (Large Home)</option>
                    <option value="10">10 kW (Small Business)</option>
                    <option value="15">15 kW (Medium Business)</option>
                    <option value="20">20 kW (Large Business)</option>
                </select>
                <div class="invalid-feedback">Please select your generator size.</div>
            </div>
            <div class="mb-3">
                <label for="generator-fuel" class="form-label">Monthly Fuel Consumption (Liters)</label>
                <input type="number" class="form-control" id="generator-fuel" value="100" required min="0">
                <div class="invalid-feedback">Please enter fuel consumption.</div>
            </div>
            <div class="mb-3">
                <label for="generator-maintenance" class="form-label">Annual Maintenance Cost (NGN)</label>
                <input type="number" class="form-control" id="generator-maintenance" value="50000" required min="0">
                <div class="invalid-feedback">Please enter maintenance cost.</div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev"><i class="fas fa-arrow-left"></i> Previous</button>
                <button type="button" class="btn btn-solar btn-next">Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Step 3: Appliances -->
        <div id="step3" class="step-container d-none">
            <h3 class="mb-4">Appliances & Equipment</h3>
            <div class="table-responsive">
                <table class="table table-dark">
                    <thead>
                        <tr>
                            <th>Appliance</th>
                            <th>Watts</th>
                            <th>Quantity</th>
                            <th>Hours/Day</th>
                            <th>Daily kWh</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Pre-filled appliance rows with selected default appliances -->
                        <tr class="appliance-row">
                            <td>
                                <select class="form-select appliance-select" required>
                                    <option value="">Select Appliance</option>
                                    {% for appliance in ['LED Lights', 'Ceiling Fan', 'Standing Fan', 'Smartphone Charger', 'Laptop', 'Desktop Computer', 'TV (32-inch LED)', 'TV (43-inch LED)', 'TV (55-inch LED)', 'Small Refrigerator', 'Large Refrigerator', 'Chest Freezer', 'Air Conditioner (1HP)', 'Air Conditioner (1.5HP)', 'Air Conditioner (2HP)', 'Electric Iron', 'Microwave', 'Electric Kettle', 'Water Dispenser', 'Security Lights', 'CCTV System', 'Small Water Pump', 'Large Water Pump'] %}
                                        <option value="{{ appliance }}" {% if appliance == 'LED Lights' %}selected{% endif %}>{{ appliance }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" class="form-control watts" value="10" readonly></td>
                            <td><input type="number" class="form-control quantity" value="8" min="1" required></td>
                            <td><input type="number" class="form-control hours" value="12" min="0" max="24" required></td>
                            <td><span class="daily-kwh">0.96</span></td>
                        </tr>
                        <tr class="appliance-row">
                            <td>
                                <select class="form-select appliance-select" required>
                                    <option value="">Select Appliance</option>
                                    {% for appliance in ['LED Lights', 'Ceiling Fan', 'Standing Fan', 'Smartphone Charger', 'Laptop', 'Desktop Computer', 'TV (32-inch LED)', 'TV (43-inch LED)', 'TV (55-inch LED)', 'Small Refrigerator', 'Large Refrigerator', 'Chest Freezer', 'Air Conditioner (1HP)', 'Air Conditioner (1.5HP)', 'Air Conditioner (2HP)', 'Electric Iron', 'Microwave', 'Electric Kettle', 'Water Dispenser', 'Security Lights', 'CCTV System', 'Small Water Pump', 'Large Water Pump'] %}
                                        <option value="{{ appliance }}" {% if appliance == 'Ceiling Fan' %}selected{% endif %}>{{ appliance }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" class="form-control watts" value="75" readonly></td>
                            <td><input type="number" class="form-control quantity" value="4" min="1" required></td>
                            <td><input type="number" class="form-control hours" value="16" min="0" max="24" required></td>
                            <td><span class="daily-kwh">4.80</span></td>
                        </tr>
                        <tr class="appliance-row">
                            <td>
                                <select class="form-select appliance-select" required>
                                    <option value="">Select Appliance</option>
                                    {% for appliance in ['LED Lights', 'Ceiling Fan', 'Standing Fan', 'Smartphone Charger', 'Laptop', 'Desktop Computer', 'TV (32-inch LED)', 'TV (43-inch LED)', 'TV (55-inch LED)', 'Small Refrigerator', 'Large Refrigerator', 'Chest Freezer', 'Air Conditioner (1HP)', 'Air Conditioner (1.5HP)', 'Air Conditioner (2HP)', 'Electric Iron', 'Microwave', 'Electric Kettle', 'Water Dispenser', 'Security Lights', 'CCTV System', 'Small Water Pump', 'Large Water Pump'] %}
                                        <option value="{{ appliance }}" {% if appliance == 'Laptop' %}selected{% endif %}>{{ appliance }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" class="form-control watts" value="65" readonly></td>
                            <td><input type="number" class="form-control quantity" value="2" min="1" required></td>
                            <td><input type="number" class="form-control hours" value="8" min="0" max="24" required></td>
                            <td><span class="daily-kwh">1.04</span></td>
                        </tr>
                        <tr class="appliance-row">
                            <td>
                                <select class="form-select appliance-select" required>
                                    <option value="">Select Appliance</option>
                                    {% for appliance in ['LED Lights', 'Ceiling Fan', 'Standing Fan', 'Smartphone Charger', 'Laptop', 'Desktop Computer', 'TV (32-inch LED)', 'TV (43-inch LED)', 'TV (55-inch LED)', 'Small Refrigerator', 'Large Refrigerator', 'Chest Freezer', 'Air Conditioner (1HP)', 'Air Conditioner (1.5HP)', 'Air Conditioner (2HP)', 'Electric Iron', 'Microwave', 'Electric Kettle', 'Water Dispenser', 'Security Lights', 'CCTV System', 'Small Water Pump', 'Large Water Pump'] %}
                                        <option value="{{ appliance }}" {% if appliance == 'TV (32-inch LED)' %}selected{% endif %}>{{ appliance }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" class="form-control watts" value="50" readonly></td>
                            <td><input type="number" class="form-control quantity" value="2" min="1" required></td>
                            <td><input type="number" class="form-control hours" value="6" min="0" max="24" required></td>
                            <td><span class="daily-kwh">0.60</span></td>
                        </tr>
                        <tr class="appliance-row">
                            <td>
                                <select class="form-select appliance-select" required>
                                    <option value="">Select Appliance</option>
                                    {% for appliance in ['LED Lights', 'Ceiling Fan', 'Standing Fan', 'Smartphone Charger', 'Laptop', 'Desktop Computer', 'TV (32-inch LED)', 'TV (43-inch LED)', 'TV (55-inch LED)', 'Small Refrigerator', 'Large Refrigerator', 'Chest Freezer', 'Air Conditioner (1HP)', 'Air Conditioner (1.5HP)', 'Air Conditioner (2HP)', 'Electric Iron', 'Microwave', 'Electric Kettle', 'Water Dispenser', 'Security Lights', 'CCTV System', 'Small Water Pump', 'Large Water Pump'] %}
                                        <option value="{{ appliance }}" {% if appliance == 'Large Refrigerator' %}selected{% endif %}>{{ appliance }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="number" class="form-control watts" value="250" readonly></td>
                            <td><input type="number" class="form-control quantity" value="1" min="1" required></td>
                            <td><input type="number" class="form-control hours" value="24" min="0" max="24" required></td>
                            <td><span class="daily-kwh">6.00</span></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end"><strong>Total Daily Power:</strong></td>
                            <td><span id="total-daily-power">13.40</span> kWh</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button type="button" class="btn btn-outline-light mb-3" onclick="addApplianceRow()">
                <i class="fas fa-plus"></i> Add Appliance
            </button>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev"><i class="fas fa-arrow-left"></i> Previous</button>
                <button type="button" class="btn btn-solar btn-next">Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- Step 4: Budget and Backup -->
        <div id="step4" class="step-container d-none">
            <h3 class="mb-4">Budget & Backup Requirements</h3>
            <div class="mb-3">
                <label for="budget-range" class="form-label">Budget Range (NGN)</label>
                <select class="form-select" id="budget-range" required>
                    <option value="500000-1000000">500,000 - 1,000,000</option>
                    <option value="1000000-2000000" selected>1,000,000 - 2,000,000</option>
                    <option value="2000000-5000000">2,000,000 - 5,000,000</option>
                    <option value="5000000+">5,000,000+</option>
                </select>
                <div class="invalid-feedback">Please select your budget range.</div>
            </div>
            <div class="mb-3">
                <label for="backup-days" class="form-label">Desired Backup Days</label>
                <input type="number" class="form-control" id="backup-days" value="2" min="1" max="7" required>
                <div class="invalid-feedback">Please enter desired backup days (1-7).</div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev"><i class="fas fa-arrow-left"></i> Previous</button>
                <button type="button" class="btn btn-solar" id="calculate-btn">Calculate Results</button>
            </div>
        </div>
    </form>

    <!-- Results Section -->
    <div id="results-section" class="d-none mt-5">
        <div class="results-card">
            <h3 class="mb-4">Your Solar Solution</h3>
            <div class="row g-4">
                <div class="col-md-6">
                    <h5>System Requirements</h5>
                    <p>Solar Panel Size: <span id="system-size" class="value-highlight">0</span> kW</p>
                    <p>Battery Capacity: <span id="battery-size" class="value-highlight">0</span> kWh</p>
                </div>
                <div class="col-md-6">
                    <h5>Financial Analysis</h5>
                    <p>Total System Cost: ₦<span id="total-cost" class="value-highlight">0</span></p>
                    <p>Current Monthly Cost: ₦<span id="current-cost" class="value-highlight">0</span></p>
                    <p>Monthly Savings: ₦<span id="monthly-savings" class="value-highlight">0</span></p>
                    <p>Payback Period: <span id="payback-period" class="value-highlight">0</span> years</p>
                </div>
            </div>
        </div>

        <!-- ROI Chart -->
        <div class="chart-container">
            <canvas id="roi-chart"></canvas>
        </div>

        <!-- Lead Capture Form -->
        <div class="results-card">
            <h3 class="mb-4">Get Detailed Quote</h3>
            <form action="{{ url_for('submit_lead') }}" method="POST" class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                        <div class="invalid-feedback">Please enter your name.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                        <div class="invalid-feedback">Please enter a valid phone number.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="contact-time" class="form-label">Best Time to Contact</label>
                        <select class="form-select" id="contact-time" name="contact_time" required>
                            <option value="">Choose time...</option>
                            <option value="morning">Morning (9AM - 12PM)</option>
                            <option value="afternoon">Afternoon (12PM - 4PM)</option>
                            <option value="evening">Evening (4PM - 7PM)</option>
                            <option value="afternoon" selected>Afternoon (12PM - 4PM)</option>
                        </select>
                        <div class="invalid-feedback">Please select a contact time.</div>
                    </div>
                </div>
                <input type="hidden" id="lead-system-size" name="system_size">
                <input type="hidden" id="lead-estimated-savings" name="estimated_savings">
                <button type="submit" class="btn btn-solar mt-4">Get Quote</button>
            </form>
        </div>
    </div>
</div>

<script>
function addApplianceRow() {
    const tbody = document.querySelector('tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'appliance-row';
    newRow.innerHTML = `
        <td>
            <select class="form-select appliance-select" required>
                <option value="">Select Appliance</option>
                <!-- Add options here dynamically or from a separate data source -->
            </select>
        </td>
        <td><input type="number" class="form-control watts" min="0" required></td>
        <td><input type="number" class="form-control quantity" value="1" min="1" required></td>
        <td><input type="number" class="form-control hours" min="0" max="24" required></td>
        <td><span class="daily-kwh">0.00</span></td>
    `;
    tbody.appendChild(newRow);

    // Add event listeners to new inputs
    const inputs = newRow.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', () => calculator.updateAppliancePower());
    });
}

// Update sun hours when location changes
document.getElementById('location').addEventListener('change', function() {
    document.getElementById('sun-hours').value = this.value;
});
</script>
{% endblock %}